-- Align k87747_permits schema with latest application requirements
-- Run this after importing the original dump (k87747_permits.sql) via phpMyAdmin.
-- Compatible with MySQL 8.0+

START TRANSACTION;

-- Run each ALTER only once; if you re-run the script later you may ignore
-- "Duplicate column" errors as it simply means the column already exists.
ALTER TABLE `form_templates`
  ADD COLUMN `created_by` VARCHAR(191) NULL AFTER `json_schema`;

ALTER TABLE `form_templates`
  ADD COLUMN `published_at` DATETIME NULL AFTER `created_by`;

ALTER TABLE `form_templates`
  ADD COLUMN `updated_at` DATETIME NULL AFTER `published_at`;

-- Backfill timestamps for existing rows so new code sees sensible values
UPDATE `form_templates`
   SET `published_at` = COALESCE(`published_at`, NOW()),
       `updated_at` = COALESCE(`updated_at`, NOW())
 WHERE `published_at` IS NULL
    OR `updated_at` IS NULL;

-- Create settings table if this database snapshot predates it
CREATE TABLE IF NOT EXISTS `settings` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `key` varchar(191) NOT NULL,
  `value` longtext,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `settings_key_unique` (`key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Seed default permit duration presets used by the admin duration manager
INSERT INTO `settings` (`key`, `value`, `updated_at`)
VALUES
  (
    'permit_duration_presets',
    '[{"label":"1 hour","minutes":60},{"label":"4 hours","minutes":240},{"label":"1 day","minutes":1440}]',
    NOW()
  )
ON DUPLICATE KEY UPDATE
    `value` = VALUES(`value`),
    `updated_at` = VALUES(`updated_at`);

COMMIT;
